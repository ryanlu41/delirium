# -*- coding: utf-8 -*-
"""
Created on Thu Oct  1 15:19:44 2020

This takes the data generated by GetChartEventsDeliriumLabels, and uses it 
to generate labels for validating the First 24 Hr Delirium Prediction Model 
on MIMIC-III. 

#Ends with 5299 ICU stays.

Runtime: a few seconds.
@author: Kirby
"""
#%% Package setup and loading in data.
import pandas as pd

del_chart_events = pd.read_csv('MIMIC_chart_events_delirium_labels.csv')
icustays = pd.read_csv(r"C:\Users\Kirby\OneDrive\JHU\SCCM Datathon\mimic-iii-clinical-database-1.4\ICUSTAYS.csv",
                       usecols=['SUBJECT_ID', 'HADM_ID', 'ICUSTAY_ID',
                                'INTIME','OUTTIME','LOS'])

#%% Find if patients had delirium, and when they got it. 
del_chart_events = del_chart_events.dropna()
dataset = del_chart_events[['SUBJECT_ID', 'HADM_ID', 'ICUSTAY_ID','delirium_positive']].groupby(['SUBJECT_ID', 'HADM_ID', 'ICUSTAY_ID']).max()

#Get delirium onset times.
del_onset = del_chart_events[['ICUSTAY_ID','CHARTTIME','delirium_positive']]
del_onset = del_onset[del_onset['delirium_positive']==1]
del_onset['CHARTTIME'] = pd.to_datetime(del_onset['CHARTTIME'])
del_onset = del_onset[['ICUSTAY_ID','CHARTTIME']]
del_onset = del_onset.groupby('ICUSTAY_ID').min()
del_onset.reset_index(inplace=True)
dataset = dataset.merge(del_onset,on='ICUSTAY_ID',how='left')

#%% Remove ICU stays where the patient got delirium in the first 24 hours, or wasn't in the ICU for at least 24 hours. 
dataset = dataset.merge(icustays,on='ICUSTAY_ID',how='left')
dataset = dataset[dataset['LOS']>=1]
dataset['INTIME'] = pd.to_datetime(dataset['INTIME'])
dataset['del_onset'] = dataset['CHARTTIME'] - dataset['INTIME']
dataset = dataset[(dataset['del_onset'] >= pd.Timedelta(1, unit='day')) | (dataset['delirium_positive']==0)]

#Put onset into minutes after admit.
dataset['del_onset'] = dataset.apply(lambda row: row['del_onset'].total_seconds()/60,axis=1)

#%% Rename columns, and save off the results.
dataset.rename(columns={'CHARTTIME':'del_onset_time'},inplace=True)
dataset.sort_values('ICUSTAY_ID',inplace=True)
dataset.to_csv('MIMIC_first_24hr_prediction_dataset.csv',index=False)

#%% Find class balance
class_bal = dataset[['ICUSTAY_ID','delirium_positive']]
class_bal = class_bal.groupby('delirium_positive').count()
#4,531 (85.5%) negative to 768 (14.5%) positive.